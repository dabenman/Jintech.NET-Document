### 股票回測的機制與計算方式

股票回測是評估交易策略在歷史數據上表現的過程，主要包括以下幾個步驟：

1. **定義交易策略**  
   確定進場與出場的條件，例如基於技術指標（如移動平均線、相對強弱指數等）或其他市場信號。

2. **收集歷史數據**  
   收集所需的歷史股價數據，通常包括開盤價、收盤價、最高價、最低價和成交量等。

3. **模擬交易**  
   根據定義的交易策略，對歷史數據進行模擬交易。每次交易都需要記錄以下幾個關鍵資訊：
   - **進場價格**（Entry Price）
   - **出場價格**（Exit Price）
   - **手續費**（Commission Fees）
   - **持倉數量**（Position Size）

   模擬過程中，需計算每次交易的獲利與虧損。

4. **計算交易成本**  
   每次交易的實際成本應該包含手續費與可能的稅金，計算公式如下：

   - **交易成本**：
   $$
   \text{交易成本} = \text{手續費} + \text{稅金}
   $$

5. **計算獲利**  
   計算每筆交易的獲利：
   $$
   \text{獲利} = (\text{出場價格} - \text{進場價格}) \times \text{持倉數量} - \text{交易成本}
   $$

6. **績效評估**  
   在回測結束後，計算整體績效，包括：
   - **總獲利**（Total Profit）：
   $$
   \text{總獲利} = \sum \text{每筆交易的獲利}
   $$
   - **年化報酬率**（Annualized Return）：
   $$
   \text{年化報酬率} = \left( \frac{\text{最終資本}}{\text{初始資本}} \right)^{\frac{1}{\text{年數}}} - 1
   $$
   - **最大回撤**（Maximum Drawdown）：衡量資本的最大跌幅。

7. **優化與調整**  
   根據回測結果，調整交易策略以提高績效，可能需要重新評估進場與出場的條件。

### 注意事項
- 確保使用的歷史數據準確且完整。
- 回測結果不能保證未來的表現，需謹慎評估策略的有效性。
